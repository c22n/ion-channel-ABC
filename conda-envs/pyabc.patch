From 702f9a4f2877e1a9c152f2cee40db2cf2c0cfac1 Mon Sep 17 00:00:00 2001
From: Charles Houston <charles.houston@protonmail.com>
Date: Wed, 16 May 2018 11:18:27 +0100
Subject: [PATCH 1/3] speedup multivariate normal sampling with numpy

---
 pyabc/transition/multivariatenormal.py | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/pyabc/transition/multivariatenormal.py b/pyabc/transition/multivariatenormal.py
index 48404a3..4f234ab 100644
--- a/pyabc/transition/multivariatenormal.py
+++ b/pyabc/transition/multivariatenormal.py
@@ -69,6 +69,16 @@ class MultivariateNormalTransition(Transition):
         self.cov = sample_cov * bw_factor**2 * self.scaling
         self.normal = st.multivariate_normal(cov=self.cov, allow_singular=True)
 
+    def rvs(self, size=None):
+        if size is None:
+            return self.rvs_single()
+        else:
+            sample = self.X.sample(n=size, replace=True, weights=self.w).iloc[:]
+            perturbed = (sample +
+                         np.random.multivariate_normal(
+                             np.zeros(self.cov.shape[0]), self.cov, size=size))
+            return pd.DataFrame(perturbed)
+
     def rvs_single(self):
         sample = self.X.sample(weights=self.w).iloc[0]
         perturbed = (sample +
-- 
2.17.0


From 0fbae34ad1799c50c4221a40cec8fc2d8b1ebb1e Mon Sep 17 00:00:00 2001
From: Charles Houston <charles.houston@protonmail.com>
Date: Wed, 16 May 2018 11:18:56 +0100
Subject: [PATCH 2/3] catch additional error in adaptive population size

---
 pyabc/transition/predict_population_size.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/pyabc/transition/predict_population_size.py b/pyabc/transition/predict_population_size.py
index 7228e40..d838650 100644
--- a/pyabc/transition/predict_population_size.py
+++ b/pyabc/transition/predict_population_size.py
@@ -40,7 +40,7 @@ def predict_population_size(current_poop_size: int,
         popt, f, finv = fitpowerlaw(n_samples_list, cvs)
         suggested_pop_size = finv(target_cv)
         return CVEstimate(suggested_pop_size, n_samples_list, cvs, f, popt)
-    except RuntimeError:
+    except (RuntimeError, ValueError):
         logger.warning("Power law fit failed. "
                        "Falling back to current nr particles {}"
                        .format(current_poop_size))
-- 
2.17.0


From f66a9a0835a9f2fcc425efd3849feaa34ae23328 Mon Sep 17 00:00:00 2001
From: Charles Houston <charles.houston@protonmail.com>
Date: Wed, 16 May 2018 11:20:06 +0100
Subject: [PATCH 3/3] optionally replot on same seaborn PairGrid

---
 pyabc/visualization.py | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/pyabc/visualization.py b/pyabc/visualization.py
index 687d53b..1f6f6ed 100644
--- a/pyabc/visualization.py
+++ b/pyabc/visualization.py
@@ -247,7 +247,7 @@ def plot_kde_2d(df, w, x, y, xmin=None, xmax=None, ymin=None, ymax=None,
     return ax
 
 
-def plot_kde_matrix(df, w, limits=None, colorbar=True):
+def plot_kde_matrix(df, w, limits=None, colorbar=True, grid=None):
     """
     Plot a KDE matrix.
 
@@ -261,8 +261,12 @@ def plot_kde_matrix(df, w, limits=None, colorbar=True):
         Whether to plot the colorbars or not.
     limits: dictionary, optional
         Dictionary of the form ``{"name": (lower_limit, upper_limit)}``.
+    grid: sns.PairGrid
+        Optionally pass in an existing seaborn pairgrid to use.
     """
-    grid = sns.PairGrid(df, diag_sharey=False)
+    if grid is None:
+        grid = sns.PairGrid(df, diag_sharey=False)
+
     if limits is None:
         limits = {}
 
-- 
2.17.0

